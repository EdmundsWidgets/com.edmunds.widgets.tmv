!function(a){"use strict";var b={min:250,max:970,value:250},c=_.template(['<div id="prise-promise-button-disabled" class="clearfix"><span class="logo"></span><button class="price-button disabled" disabled="disabled">Get Your Special Offer</button></div>'].join("")),d=Backbone.View.extend({events:{"click #widget-get":"onSubmit",reset:"onReset","valid #vehicle-api-key-control":"onVehicleApiKeyChange","valid #zip-code-control":"onZipCodeChange","valid #vin-code-control":"onVinKeyChange","keyup #vehicle-api-key-input":"onApplyApiKey","keyup #vin-code-input":"onApplyVinKey","keyup #zip-code-input":"onApplyZipCode","keypress #zip-code-input":"zipCodeInputFilter","paste #zip-code-input":"zipCodeInputFilter",'click #vehicle-api-key-control [data-section="change"] .btn':"onChangeClickKey",'click #vin-code-control [data-section="change"] .btn':"onChangeClickVinKey",'click #zip-code-control [data-section="change"] .btn':"onChangeClickZip",'click #option_size button[data-value="smallButton"]':"hideSlider",'click #option_size button[data-value="largeButton"]':"showSlider"},initialize:function(){var c=this;this.placeHolderWidth=null,a.vin="please enter VIN here",this.$width=this.$('[name="width"]'),this.$height=this.$('[name="height"]'),this.$widthSlider=this.$("#width_slider"),this.$inputVin=this.$("#vin-code-input"),this.vehicleApiControl=this.$("#vehicle-api-key-control").inputGroupControl({tooltipTitle:"Please enter a valid API key",validate:this.vehicleApiKeyValidator}).data("inputGroupControl"),this.vinCodeControl=this.$("#vin-code-control").inputGroupControl({tooltipTitle:"Please enter a valid VIN",disabled:!0,validate:this.vin}).data("inputGroupControl"),this.vinCodeControl.disable(),this.zipCodeControl=this.$("#zip-code-control").inputGroupControl({tooltipTitle:"Please enter a valid ZIP code",disabled:!0,validate:this.zipCodeValidator}).data("inputGroupControl"),this.zipCodeControl.disable(),this.$("#vehicle-api-key-control div[data-section=change] .btn").on("click",$.proxy(this.zipCodeReset,this)),this.$("#option_colorscheme").radioGroup({name:"colorScheme",value:"light"}).on("change",function(b,d,e){$("#widget-placeholder")["dark"===e?"addClass":"removeClass"]("dark"),c.options.colorscheme=e,a.vin&&"please enter VIN here"!==a.vin&&c.renderWidget()}).data("radiogroup"),this.$("#option_size").radioGroup({name:"buttonSize",value:"largeButton"}).on("change",function(b,d,e){$("#widget-placeholder")["smallButton"===e?"addClass":"removeClass"]("smallButton"),c.options.buttonSize=e,a.vin&&"please enter VIN here"!==a.vin&&c.renderWidget()}).data("radiogroup"),this.$("#option_colorscheme button").on("click",$.proxy(this.onChangeClass,this)),this.$("#option_size button").on("click",$.proxy(this.onChangeClass,this)),this.$('#option_size button[data-value="smallButton"]').on("click",$.proxy(this.changeSmallButtonText,this)),this.$('#option_size button[data-value="largeButton"]').on("click",$.proxy(this.removeSpan,this)),this.widthSlider=this.createSlider(this.$widthSlider,b,_.bind(this.onWidthChange,this)),this.renderWidget=_.debounce(this.renderWidget,500)},$widgetPlaceholder:$("#widget-placeholder"),renderWidget:function(){if(this.options=this.toJSON(),!this.vehicleApiKey||!this.zipCode||void 0===this.vin||void 0===a.vin)return void this.loading();this.$widgetPlaceholder.find("#ppb").remove(),this.$widgetPlaceholder.find("#ppb-"+this.vin).remove();var b='<div id="ppb-'+this.vin+'"></div>';return this.$widgetPlaceholder.width(this.placeHolderWidth),this.$widgetPlaceholder.prepend(b),this.widget=EDM.createWidget({type:"ppb",renderTo:"ppb-"+this.options.vin,style:{width:this.options.width.replace("px",""),height:this.options.height.replace("px",""),color:this.options.colorScheme,size:this.options.buttonSize},scripts:['/libs/requirejs/require.js" data-main="js/main.js'],options:{apiKey:a.apiKey,vin:a.vin,zipCode:a.zipCode,isConfigurator:!0,size:this.options.buttonSize}}),this},loading:function(){this.$widgetPlaceholder.find("#ppb").remove(),this.$widgetPlaceholder.find("#ppb-"+a.vin).remove(),this.$widgetPlaceholder.prepend('<div id="ppb"></div>'),this.$widgetPlaceholder.find("#ppb").html(c),this.changeSmallButtonText()},changeSmallButtonText:function(){var a=this.$widgetPlaceholder.find(".price-button");this.$widgetPlaceholder.hasClass("smallButton")&&a.html('<span class="special-offer">Special Offer</span>')},removeSpan:function(){var a=this.$widgetPlaceholder.find(".price-button");a.find(".special-offer").remove(),a.text("Get Your Special Offer")},createSlider:function(a,b,c){return a.slider({range:"min",value:b.value,min:b.min,max:b.max,create:function(){$(this).find(".ui-slider-handle").tooltip({animation:!1,title:b.value+"px",trigger:"manual",placement:"bottom",container:a.find(".ui-slider-handle")}).tooltip("show")},slide:function(a,b){$(this).find(".ui-slider-handle .tooltip-inner").text(b.value+"px")},change:function(a,b){$(this).find(".ui-slider-handle .tooltip-inner").text(b.value+"px"),_.isFunction(c)&&c(b.value)}}).data("ui-slider")},onWidthChange:function(b){var c=this.$widgetPlaceholder.find(".price-button"),d=this.$widgetPlaceholder.find(".logo"),e=this.$widgetPlaceholder.find("#prise-promise-button-disabled");this.$widgetPlaceholder.hasClass("smallButton")?this.placeHolderWidth=b:(e.css("display","inline-block"),this.placeHolderWidth=b,this.$width.val(this.placeHolderWidth+"px"),this.$height.val("100px"),a.zipCode=this.zipCode,this.$widgetPlaceholder.width(this.placeHolderWidth+"px"),b>=452?(this.$height.val("100px"),e.css("display","block"),d.css({"vertical-align":-11,display:"inline-block","margin-right":5}),c.css("display","inline-block")):d.css({"vertical-align":-11,display:"inline-block","margin-right":0}),b>=474&&this.$height.val("75px"),a.vin&&"please enter VIN here"!==a.vin&&this.renderWidget())},onVehicleApiKeyChange:function(b,c){this.vehicleApiKey=c,a.apiKey=this.vehicleApiKey,this.zipCodeControl.enable(),this.$("#franchise-id-input").focus(),this.zipCodeControl.options.apiKey=c},onChangeClass:function(a){var b=a.currentTarget;$(b).hasClass("active")?$(b).removeClass("active"):$(b).addClass("active")},onChangeClickKey:function(){this.vehicleApiKey=void 0},onChangeClickVinKey:function(){this.vin=void 0,this.renderWidget()},onVinKeyChange:function(b,c){this.vin=c,a.vin=this.vin,this.renderWidget()},vehicleApiKeyValidator:function(a){var b=new jQuery.Deferred;return a?(jQuery.ajax({url:"/api/keyvalidate",data:{api_key:a,service:"vehicle"},dataType:"json",context:this,success:function(c){b[c.valid===!0?"resolveWith":"rejectWith"](this,[a])},error:function(){b.rejectWith(this,[a])}}),b.promise()):(b.rejectWith(this,[a]),b.promise())},validateVin:function(){var b=this.$inputVin.val();this.vin=a.vin=vinValidate.validVin(b)?b:"please enter VIN here"},vin:function(b){var c=new jQuery.Deferred;return vinValidate.validVin(b)&&b?(this.vin=a.vin=b,c.resolveWith(this,[b]),c.promise()):(this.vin=a.vin="please enter VIN here",c.rejectWith(this,[b]),c.promise())},onZipCodeChange:function(b,c){this.zipCode=c,a.zipCode=this.zipCode,this.vehicleApiKey&&(this.vinCodeControl.enable(),this.renderWidget())},onApplyZipCode:function(a){13==a.keyCode&&$("#zip-code-apply").click()},zipCodeInputFilter:function(a){var b=a.keyCode||a.which,c=String.fromCharCode(b),d=/[0-9]/;if(8!==b)return d.test(c)?void 0:(a.preventDefault(),!1)},onChangeClickZip:function(){this.zipCode=void 0},zipCodeValidator:function(a){var b=new jQuery.Deferred,c="http://api.edmunds.com/v1/api/region/zip/validation/";return-1!==window.location.href.indexOf("https")&&(c=c.replace("http:","https:")),/^\d{5}$/.test(a)?(jQuery.ajax({url:c+a,data:{api_key:this.options.apiKey},dataType:"jsonp",context:this,success:function(c){b["true"===c[a]?"resolveWith":"rejectWith"](this,[a])},error:function(){b.rejectWith(this,[a])}}),b.promise()):(b.rejectWith(this,[a]),b.promise())},zipCodeReset:function(){this.renderWidget()},onApplyApiKey:function(a){13==a.keyCode&&$("#vehicle-api-key-apply").click()},onApplyVinKey:function(a){13==a.keyCode&&$("#vin-code-apply").click()},toJSON:function(){var a={};return _.each(this.$el.serializeArray(),function(b){a[b.name]=b.value}),a},onSubmit:function(b){var c=!0,d='&lt;div id="ppb-'+a.vin+'"&gt;&lt;/div&gt;';b.preventDefault(),this.vehicleApiKey||(this.vehicleApiControl.$input.tooltip("show"),c=!1),this.zipCode||(this.zipCodeControl.$input.tooltip("show"),c=!1),this.vin&&"please enter VIN here"!=a.vin||(this.vinCodeControl.$input.tooltip("show"),c=!1),c&&(console.log(this.toJSON()),$("#insert-js").html(this.getJavaScriptSnippet()),$("#widget-instructions").modal({backdrop:"static",show:!0}),$(".div-id").html(d))},getJavaScriptSnippet:function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g},-1!==window.location.href.indexOf("https")&&(d.ORIGIN=d.ORIGIN.replace("http:","https:"));var a=this.htmlEntities(['<script type="text/javascript" src="'+d.ORIGIN+'/loader-ppb.js"></script>\n','<script type="text/javascript">\n'+$("#js-snippet-template").html()+"\n</script>"].join(""));return _.template(a,{widgetConfig:JSON.stringify(this.getWidgetConfig(),"",4)},!0)},htmlEntities:function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},getWidgetConfig:function(){return this.$widgetPlaceholder.hasClass("smallButton")&&(this.options.height="50"),-1!==window.location.href.indexOf("https")&&(d.ORIGIN=d.ORIGIN.replace("http:","https:")),{type:"ppb",renderTo:"ppb-"+this.options.vin,style:{width:this.options.width.replace("px",""),height:this.options.height.replace("px",""),color:this.options.colorScheme,size:this.options.buttonSize},scripts:['/libs/requirejs/require.js" data-main="'+d.ORIGIN+"/ppb/js/main.js"],options:{apiKey:a.apiKey,vin:a.vin,zipCode:a.zipCode,size:this.options.buttonSize}}},onReset:function(){this.vinCodeControl.reset(),this.zipCodeControl.reset(),this.vehicleApiKey&&this.zipCodeControl.enable(),this.widthSlider.option(b),this.vin=void 0,this.widget=null,this.renderWidget()},reset:function(){return this.el.reset(),this},hideSlider:function(){this.createSlider(this.$widthSlider,b,null),this.$widgetPlaceholder.width("250px"),this.$width.val("250px"),this.$height.val("50px"),this.$(".slider").hide()},showSlider:function(){var a=this.$(".slider");this.$height.val("100px"),this.createSlider(this.$widthSlider,b,_.bind(this.onWidthChange,this)),a.is(":hidden")&&a.show()}});a.PpbConfigurator=d}(this);